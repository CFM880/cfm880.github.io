<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Android æ ¡æ—¶å…¨è¿‡ç¨‹ | JsonMi</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Android æ ¡æ—¶å…¨è¿‡ç¨‹</h1><a id="logo" href="/.">JsonMi</a><p class="description">Android Java</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> ä¸»é¡µ</i></a><a href="/archives/"><i class="fa fa-archive"> å½’æ¡£</i></a><a href="/about/"><i class="fa fa-user"> å…³äºæˆ‘</i></a><a href="/atom.xml"><i class="fa fa-rss"> è®¢é˜…</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Android æ ¡æ—¶å…¨è¿‡ç¨‹</h1><div class="post-meta">Aug 4, 2018</div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">æ–‡ç« ç›®å½•</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#ç›¸å…³ç±»å›¾"><span class="toc-number">1.</span> <span class="toc-text">ç›¸å…³ç±»å›¾</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ç³»ç»Ÿè®¾ç½®"><span class="toc-number">1.1.</span> <span class="toc-text">ç³»ç»Ÿè®¾ç½®</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ç³»ç»Ÿæ ¡æ—¶"><span class="toc-number">1.2.</span> <span class="toc-text">ç³»ç»Ÿæ ¡æ—¶</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ç³»ç»Ÿè®¾ç½®ä¸æ—¶é—´ç›¸å…³éƒ¨åˆ†"><span class="toc-number">2.</span> <span class="toc-text">ç³»ç»Ÿè®¾ç½®ä¸æ—¶é—´ç›¸å…³éƒ¨åˆ†</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#è®¾ç½®æ—¶é—´"><span class="toc-number">2.1.</span> <span class="toc-text">è®¾ç½®æ—¶é—´</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#è‡ªåŠ¨æ ¡æ—¶è®¾ç½®"><span class="toc-number">2.2.</span> <span class="toc-text">è‡ªåŠ¨æ ¡æ—¶è®¾ç½®</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ç³»ç»Ÿæ ¡æ—¶éƒ¨åˆ†"><span class="toc-number">3.</span> <span class="toc-text">ç³»ç»Ÿæ ¡æ—¶éƒ¨åˆ†</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ServerManagerä¸æ ¡æ—¶ç›¸å…³çš„"><span class="toc-number">3.1.</span> <span class="toc-text">ServerManagerä¸æ ¡æ—¶ç›¸å…³çš„</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NetworkTimeUpdateService"><span class="toc-number">3.2.</span> <span class="toc-text">NetworkTimeUpdateService</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#NetworkTimeUpdateServiceåˆå§‹åŒ–"><span class="toc-number">3.2.1.</span> <span class="toc-text">NetworkTimeUpdateServiceåˆå§‹åŒ–</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#æ ¡æ—¶è½®è¯¢"><span class="toc-number">3.2.2.</span> <span class="toc-text">æ ¡æ—¶è½®è¯¢</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#æ‰§è¡Œé€»è¾‘"><span class="toc-number">3.2.3.</span> <span class="toc-text">æ‰§è¡Œé€»è¾‘</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ç³»ç»Ÿæ ¡æ—¶æ€»ç»“"><span class="toc-number">3.3.</span> <span class="toc-text">ç³»ç»Ÿæ ¡æ—¶æ€»ç»“</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#å¯¹äºæˆ‘ä»¬appæ¥è¯´åº”è¯¥æ€ä¹ˆå¼„"><span class="toc-number">4.</span> <span class="toc-text">å¯¹äºæˆ‘ä»¬appæ¥è¯´åº”è¯¥æ€ä¹ˆå¼„</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#è®¾ç½®æ—¶é—´ç›®å‰æˆ‘ä»¬æœ‰4ç§æ–¹å¼"><span class="toc-number">4.1.</span> <span class="toc-text">è®¾ç½®æ—¶é—´ç›®å‰æˆ‘ä»¬æœ‰4ç§æ–¹å¼</span></a></li></ol></li></ol></div></div><div class="post-content"><p>å¯¹äºä¸€ä¸ªLauncheræ¥è¯´ï¼Œæ—¶é—´åŸºå‡†æ˜¯æœ€ä¸ºé‡è¦çš„ï¼Œç‰¹åˆ«æ˜¯æˆ‘ä»¬è¿™ç§æ²¡æœ‰ç³»ç»Ÿé¡¶éƒ¨çš„é€šçŸ¥æ çš„appï¼Œè€Œä¸”ä¼šç»å¸¸æ–­ç”µé‡å¯çš„Androidæœºå™¨ï¼ŒAndroidè‡ªå¸¦çš„æ ¡æ—¶ï¼Œç”±äºæŸäº›åŸå› ï¼Œæ ¡æ—¶æ¯”è¾ƒæ…¢ï¼Œéœ€è¦åœ¨appä¸ŠåŠ ä¸Šä¸€ä¸ªæ ¡æ—¶æ‰èƒ½ä¿è¯åœ¨æœ‰ç½‘çš„æƒ…å†µä¸‹ç¬¬ä¸€æ—¶é—´æ ¡æ—¶ã€‚<br><a id="more"></a></p>
<p>åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œæ ¡æ—¶è¿˜æ˜¯æ¯”è¾ƒé‡è¦çš„ä¾‹å¦‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.ç›´æ’­è¯¾çš„å¼€å§‹æ—¶é—´</span><br><span class="line">2.è¯¾ç¨‹è¡¨çš„å®šä½</span><br><span class="line">3.ä»Šå¤©æ˜å¤©ï¼ˆè¿™ç§å¯¹ç”¨æˆ·å‹å¥½çš„æ—¥æœŸæ–¹å¼ï¼‰</span><br></pre></td></tr></table></figure></p>
<h2 id="ç›¸å…³ç±»å›¾"><a href="#ç›¸å…³ç±»å›¾" class="headerlink" title="ç›¸å…³ç±»å›¾"></a>ç›¸å…³ç±»å›¾</h2><h3 id="ç³»ç»Ÿè®¾ç½®"><a href="#ç³»ç»Ÿè®¾ç½®" class="headerlink" title="ç³»ç»Ÿè®¾ç½®"></a>ç³»ç»Ÿè®¾ç½®</h3><p><img src="https://wx3.sinaimg.cn/mw1024/c2ab4ab1ly1fxcmb61uhej21bo0pgdiq.jpg" alt="ç³»ç»Ÿè®¾ç½®"></p>
<h3 id="ç³»ç»Ÿæ ¡æ—¶"><a href="#ç³»ç»Ÿæ ¡æ—¶" class="headerlink" title="ç³»ç»Ÿæ ¡æ—¶"></a>ç³»ç»Ÿæ ¡æ—¶</h3><p><img src="https://wx3.sinaimg.cn/mw1024/c2ab4ab1ly1fxcmb6ljwkj21w01o4n70.jpg" alt="ç³»ç»Ÿæ ¡æ—¶"></p>
<p>æ—¢ç„¶æ˜¯æ ¡æ—¶ï¼Œæˆ‘å…ˆäº†è§£ä¸€ä¸‹ç³»ç»Ÿæ˜¯æ€ä¹ˆä¸ªæ ¡æ—¶æµç¨‹ï¼Œç„¶åå†åŠ¨æ‰‹å†™è‡ªå·±çš„æ ¡æ—¶</p>
<h2 id="ç³»ç»Ÿè®¾ç½®ä¸æ—¶é—´ç›¸å…³éƒ¨åˆ†"><a href="#ç³»ç»Ÿè®¾ç½®ä¸æ—¶é—´ç›¸å…³éƒ¨åˆ†" class="headerlink" title="ç³»ç»Ÿè®¾ç½®ä¸æ—¶é—´ç›¸å…³éƒ¨åˆ†"></a>ç³»ç»Ÿè®¾ç½®ä¸æ—¶é—´ç›¸å…³éƒ¨åˆ†</h2><p>åœ¨Androidç³»ç»Ÿè‡ªå¸¦çš„è®¾ç½®ä¸­æœ‰è®¾ç½®æ—¶é—´çš„åŠŸèƒ½ï¼Œä»è¿™é‡Œå‡ºå‘æ˜¯æœ€å¥½çš„</p>
<h3 id="è®¾ç½®æ—¶é—´"><a href="#è®¾ç½®æ—¶é—´" class="headerlink" title="è®¾ç½®æ—¶é—´"></a>è®¾ç½®æ—¶é—´</h3><p>Settingsé‡ŒåŒ…å«æ‰€æœ‰Activity, è¿™é‡Œé¢æ‰€æœ‰çš„Activityåˆç»§æ‰¿SettingsActivity;<br>åœ¨SettingsActivityé‡ŒENTRY_FRAGMENTSé‡Œå…¨æ˜¯Fragmentçš„ç±»åï¼Œå¯æƒ³è€ŒçŸ¥Settings Appé‡ŒåŸºæœ¬éƒ½æ˜¯æœ‰Fragmentç»„æˆï¼Œåœ¨è¿™é‡Œé¢ï¼ŒDateTimeSettings.class.getName()ï¼Œå°¤ä¸ºè€€çœ¼ï¼Œè¿™ä¸æ˜¯æˆ‘è¦æ‰¾çš„ä¹ˆï¼Œè‡³äºï¼Œæ€ä¹ˆæŠŠè¿™ä¸ªFragmentåŠ è½½åˆ°Settingsé‡Œï¼Œç°åœ¨é‡ç‚¹ä¸åœ¨è¿™ã€‚</p>
<p>SettingsFragmentå®ç°äº†TimePickerDialog.OnTimeSetListener, DatePickerDialog.OnDateSetListener<br>è¿™ä¸¤ä¸ªå°±æ˜¯è®¾ç½®æ—¶é—´å’Œæ—¥æœŸçš„å›è°ƒã€‚</p>
<p>åœ¨onResume()é‡Œæ·»åŠ äº†æ—¶é—´æ”¹å˜çš„æ¥æ”¶å™¨ï¼Œæ¥æ”¶å™¨äº†æ›´æ–°ç›¸å…³æ—¶é—´çš„UI<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// Register for time ticks and other reasons for time change</span><br><span class="line">IntentFilter filter = new IntentFilter();</span><br><span class="line">filter.addAction(Intent.ACTION_TIME_TICK);</span><br><span class="line">filter.addAction(Intent.ACTION_TIME_CHANGED);</span><br><span class="line">filter.addAction(Intent.ACTION_TIMEZONE_CHANGED);</span><br><span class="line">getActivity().registerReceiver(mIntentReceiver, filter, null, null);</span><br></pre></td></tr></table></figure></p>
<p>åœ¨onTimeSetå’ŒonDateSeté‡Œåˆ†åˆ«å°†è®¾ç½®å¥½çš„æ—¶é—´å°è£…è¿›ä¸€ä¸ªCalenderé‡Œæœ€åè°ƒç”¨<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((AlarmManager) context.getSystemService(Context.ALARM_SERVICE)).setTime(when);</span><br></pre></td></tr></table></figure></p>
<p>ç„¶åmIntentReceiverä¼šæ¥æ”¶æ—¶é—´æ”¹å˜çš„å¹¿æ’­ï¼Œæ›´UI</p>
<h3 id="è‡ªåŠ¨æ ¡æ—¶è®¾ç½®"><a href="#è‡ªåŠ¨æ ¡æ—¶è®¾ç½®" class="headerlink" title="è‡ªåŠ¨æ ¡æ—¶è®¾ç½®"></a>è‡ªåŠ¨æ ¡æ—¶è®¾ç½®</h3><p>è¿™æ˜¯æˆ‘ä»¬åé¢appæ ¡æ—¶çš„ä¸€ç§æ–¹å¼ï¼Œä¼°è®¡æ²¡äººå‘ç°å¹¶ç”¨èµ·æ¥<br>è®¾ç½®è‡ªåŠ¨æ ¡æ—¶åœ¨OnSharedPreferenceChangeListenerçš„å›è°ƒä¸­å®Œæˆçš„<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void onSharedPreferenceChanged(SharedPreferences preferences, String key) &#123;</span><br><span class="line">    if (key.equals(KEY_AUTO_TIME)) &#123;</span><br><span class="line">        boolean autoEnabled = preferences.getBoolean(key, true);</span><br><span class="line">        Settings.Global.putInt(getContentResolver(), Settings.Global.AUTO_TIME,</span><br><span class="line">                autoEnabled ? 1 : 0);</span><br><span class="line">        mTimePref.setEnabled(!autoEnabled);</span><br><span class="line">        mDatePref.setEnabled(!autoEnabled);</span><br><span class="line">    &#125; else if (key.equals(KEY_AUTO_TIME_ZONE)) &#123;</span><br><span class="line">        boolean autoZoneEnabled = preferences.getBoolean(key, true);</span><br><span class="line">        Settings.Global.putInt(</span><br><span class="line">                getContentResolver(), Settings.Global.AUTO_TIME_ZONE, autoZoneEnabled ? 1 : 0);</span><br><span class="line">        mTimeZone.setEnabled(!autoZoneEnabled);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬åé¢ä¹Ÿå¯æ¥ä¸ªè½®è¯¢è®¾ç½®è‡ªåŠ¨æ ¡æ—¶ï¼Œç›¸å½“äºè°ƒç”¨ç³»ç»Ÿè‡ªå¸¦çš„æ ¡æ—¶apiæ ¡æ—¶ï¼Œä½†æ˜¯è¿™ç§ä¹Ÿæ˜¯éœ€è¦ç³»ç»Ÿappçš„æƒé™æ‰å¯ä»¥<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;uses-permission android:name=&quot;android.permission.WRITE_SECURE_SETTINGS&quot;/&gt;</span><br><span class="line">Settings.Global.putInt(</span><br><span class="line">                getContentResolver(), Settings.Global.AUTO_TIME_ZONE, autoZoneEnabled ? 1 : 0);</span><br></pre></td></tr></table></figure></p>
<p>è¿™æ˜¯è®¾ç½®è¿™æ¡çº¿èµ°å®Œ</p>
<h2 id="ç³»ç»Ÿæ ¡æ—¶éƒ¨åˆ†"><a href="#ç³»ç»Ÿæ ¡æ—¶éƒ¨åˆ†" class="headerlink" title="ç³»ç»Ÿæ ¡æ—¶éƒ¨åˆ†"></a>ç³»ç»Ÿæ ¡æ—¶éƒ¨åˆ†</h2><h3 id="ServerManagerä¸æ ¡æ—¶ç›¸å…³çš„"><a href="#ServerManagerä¸æ ¡æ—¶ç›¸å…³çš„" class="headerlink" title="ServerManagerä¸æ ¡æ—¶ç›¸å…³çš„"></a>ServerManagerä¸æ ¡æ—¶ç›¸å…³çš„</h3><p>Androidçš„ç³»ç»ŸæœåŠ¡éƒ½æ˜¯åœ¨Frameworkä¸­çš„ServerManagerä¸­å¯åŠ¨çš„<br>å…¶ä¸­startOtherServices()è´Ÿè´£æˆ‘ä»¬æ‰€å…³æ³¨çš„NetworkTimeUpdateServiceçš„åˆ›å»ºå’Œè¿è¡Œ;</p>
<p>ServerManagerä¸­çš„ä¸NetworkTimeUpdateServiceç›¸å…³çš„ä»£ç <br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">private void startOtherServices() &#123;</span><br><span class="line">    ...</span><br><span class="line">    NetworkTimeUpdateService networkTimeUpdater = null;</span><br><span class="line">    ...</span><br><span class="line">    if (!disableNetwork &amp;&amp; !disableNetworkTime) &#123;    // line 904</span><br><span class="line">        try &#123;</span><br><span class="line">            Slog.i(TAG, &quot;NetworkTimeUpdateService&quot;);</span><br><span class="line">            networkTimeUpdater = new NetworkTimeUpdateService(context);</span><br><span class="line">        &#125; catch (Throwable e) &#123;</span><br><span class="line">            reportWtf(&quot;starting NetworkTimeUpdate service&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    final NetworkTimeUpdateService networkTimeUpdaterF = networkTimeUpdater; //line 1080</span><br><span class="line">    ...</span><br><span class="line">    // We now tell the activity manager it is okay to run third party</span><br><span class="line">    // code.  It will call back into us once it has gotten to the state</span><br><span class="line">    // where third party code can really run (but before it has actually</span><br><span class="line">    // started launching the initial applications), for us to complete our</span><br><span class="line">    // initialization.</span><br><span class="line">    mActivityManagerService.systemReady(new Runnable() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                ...</span><br><span class="line">                try &#123;</span><br><span class="line">                    if (networkTimeUpdaterF != null) networkTimeUpdaterF.systemRunning(); // line 1174</span><br><span class="line">                &#125; catch (Throwable e) &#123;</span><br><span class="line">                    reportWtf(&quot;Notifying NetworkTimeService running&quot;, e);</span><br><span class="line">                &#125; </span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>åœ¨startOtherServicesä¸­åˆå§‹åŒ–äº†NetworkTimeUpdateService, ç„¶åè°ƒç”¨NetworkTimeUpdateService#systemRunning()</p>
<h3 id="NetworkTimeUpdateService"><a href="#NetworkTimeUpdateService" class="headerlink" title="NetworkTimeUpdateService"></a>NetworkTimeUpdateService</h3><h4 id="NetworkTimeUpdateServiceåˆå§‹åŒ–"><a href="#NetworkTimeUpdateServiceåˆå§‹åŒ–" class="headerlink" title="NetworkTimeUpdateServiceåˆå§‹åŒ–"></a>NetworkTimeUpdateServiceåˆå§‹åŒ–</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public NetworkTimeUpdateService(Context context) &#123;</span><br><span class="line">    mContext = context;</span><br><span class="line">    // è·å¾—mCachedNtpTime</span><br><span class="line">    mTime = NtpTrustedTime.getInstance(context);</span><br><span class="line">    // å®šæ—¶è§¦å‘å¹¿æ’­</span><br><span class="line">    mAlarmManager = (AlarmManager) mContext.getSystemService(Context.ALARM_SERVICE);</span><br><span class="line">    Intent pollIntent = new Intent(ACTION_POLL, null);</span><br><span class="line">    // resetAlarm()é€’å½’ç”¨çš„</span><br><span class="line">    mPendingPollIntent = PendingIntent.getBroadcast(mContext, POLL_REQUEST, pollIntent, 0);</span><br><span class="line"></span><br><span class="line">    mPollingIntervalMs = mContext.getResources().getInteger(</span><br><span class="line">            com.android.internal.R.integer.config_ntpPollingInterval);</span><br><span class="line">    mPollingIntervalShorterMs = mContext.getResources().getInteger(</span><br><span class="line">            com.android.internal.R.integer.config_ntpPollingIntervalShorter);</span><br><span class="line">    mTryAgainTimesMax = mContext.getResources().getInteger(</span><br><span class="line">            com.android.internal.R.integer.config_ntpRetry);</span><br><span class="line">    mTimeErrorThresholdMs = mContext.getResources().getInteger(</span><br><span class="line">            com.android.internal.R.integer.config_ntpThreshold);</span><br><span class="line"></span><br><span class="line">    mWakeLock = ((PowerManager) context.getSystemService(Context.POWER_SERVICE)).newWakeLock(</span><br><span class="line">            PowerManager.PARTIAL_WAKE_LOCK, TAG);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨ï¼Œåˆå§‹åŒ–Handlerï¼Œå¼€å§‹æ ¡æ—¶<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">/** Initialize the receivers and initiate the first NTP request */</span><br><span class="line">public void systemRunning() &#123;</span><br><span class="line">    // æ—¶é—´å˜åŒ–åï¼Œç¼“å­˜ä¸Šæ¬¡çš„æ—¶é—´</span><br><span class="line">    registerForTelephonyIntents();</span><br><span class="line">    // å®šæ—¶æ¥æ”¶å¹¿æ’­</span><br><span class="line">    registerForAlarms();</span><br><span class="line">    // ç½‘ç»œå˜åŒ–æ—¶ï¼Œå‘é€æ¶ˆæ¯åˆ° mHandler,å‘é€æ¶ˆæ¯</span><br><span class="line">    registerForConnectivityIntents();</span><br><span class="line"></span><br><span class="line">    HandlerThread thread = new HandlerThread(TAG);</span><br><span class="line">    thread.start();</span><br><span class="line">    mHandler = new MyHandler(thread.getLooper());</span><br><span class="line">    // Check the network time on the new thread</span><br><span class="line">    mHandler.obtainMessage(EVENT_POLL_NETWORK_TIME).sendToTarget();</span><br><span class="line"></span><br><span class="line">    mSettingsObserver = new SettingsObserver(mHandler, EVENT_AUTO_TIME_CHANGED);</span><br><span class="line">    mSettingsObserver.observe(mContext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="æ ¡æ—¶è½®è¯¢"><a href="#æ ¡æ—¶è½®è¯¢" class="headerlink" title="æ ¡æ—¶è½®è¯¢"></a>æ ¡æ—¶è½®è¯¢</h4><p>å¤„ç†çŠ¶æ€å˜åŒ–åçš„æ—¶é—´è½®è¯¢<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">/** Handler to do the network accesses on */</span><br><span class="line">private class MyHandler extends Handler &#123;</span><br><span class="line"></span><br><span class="line">    public MyHandler(Looper l) &#123;</span><br><span class="line">        super(l);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void handleMessage(Message msg) &#123;</span><br><span class="line">        switch (msg.what) &#123;</span><br><span class="line">            case EVENT_AUTO_TIME_CHANGED:</span><br><span class="line">            case EVENT_POLL_NETWORK_TIME:</span><br><span class="line">            case EVENT_NETWORK_CHANGED:</span><br><span class="line">                onPollNetworkTime(msg.what);</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">private void onPollNetworkTime(int event) &#123;</span><br><span class="line">    // If Automatic time is not set, don&apos;t bother.</span><br><span class="line">    if (!isAutomaticTimeRequested()) return;</span><br><span class="line">    mWakeLock.acquire();</span><br><span class="line">    try &#123;</span><br><span class="line">        onPollNetworkTimeUnderWakeLock(event);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        mWakeLock.release();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>onPollNetworkTimeUnderWakeLockè¿™æ˜¯æ ¡æ—¶çš„å†…å¿ƒä»£ç äº†<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">private void onPollNetworkTimeUnderWakeLock(int event) &#123;</span><br><span class="line">    final long refTime = SystemClock.elapsedRealtime();</span><br><span class="line">    // If NITZ time was received less than mPollingIntervalMs time ago,</span><br><span class="line">    // no need to sync to NTP.</span><br><span class="line">    if (mNitzTimeSetTime != NOT_SET &amp;&amp; refTime - mNitzTimeSetTime &lt; mPollingIntervalMs) &#123;</span><br><span class="line">        resetAlarm(mPollingIntervalMs);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    final long currentTime = System.currentTimeMillis();</span><br><span class="line">    if (DBG) Log.d(TAG, &quot;System time = &quot; + currentTime);</span><br><span class="line">    // Get the NTP time</span><br><span class="line">    if (mLastNtpFetchTime == NOT_SET || refTime &gt;= mLastNtpFetchTime + mPollingIntervalMs</span><br><span class="line">            || event == EVENT_AUTO_TIME_CHANGED) &#123;</span><br><span class="line">        if (DBG) Log.d(TAG, &quot;Before Ntp fetch&quot;);</span><br><span class="line"></span><br><span class="line">        // force refresh NTP cache when outdated</span><br><span class="line">        if (mTime.getCacheAge() &gt;= mPollingIntervalMs) &#123;</span><br><span class="line">            mTime.forceRefresh();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // only update when NTP time is fresh</span><br><span class="line">        if (mTime.getCacheAge() &lt; mPollingIntervalMs) &#123;</span><br><span class="line">            final long ntp = mTime.currentTimeMillis();</span><br><span class="line">            mTryAgainCounter = 0;</span><br><span class="line">            // If the clock is more than N seconds off or this is the first time it&apos;s been</span><br><span class="line">            // fetched since boot, set the current time.</span><br><span class="line">            if (Math.abs(ntp - currentTime) &gt; mTimeErrorThresholdMs</span><br><span class="line">                    || mLastNtpFetchTime == NOT_SET) &#123;</span><br><span class="line">                // Set the system time</span><br><span class="line">                if (DBG &amp;&amp; mLastNtpFetchTime == NOT_SET</span><br><span class="line">                        &amp;&amp; Math.abs(ntp - currentTime) &lt;= mTimeErrorThresholdMs) &#123;</span><br><span class="line">                    Log.d(TAG, &quot;For initial setup, rtc = &quot; + currentTime);</span><br><span class="line">                &#125;</span><br><span class="line">                if (DBG) Log.d(TAG, &quot;Ntp time to be set = &quot; + ntp);</span><br><span class="line">                // Make sure we don&apos;t overflow, since it&apos;s going to be converted to an int</span><br><span class="line">                if (ntp / 1000 &lt; Integer.MAX_VALUE) &#123;</span><br><span class="line">                    SystemClock.setCurrentTimeMillis(ntp);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                if (DBG) Log.d(TAG, &quot;Ntp time is close enough = &quot; + ntp);</span><br><span class="line">            &#125;</span><br><span class="line">            mLastNtpFetchTime = SystemClock.elapsedRealtime();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // Try again shortly</span><br><span class="line">            mTryAgainCounter++;</span><br><span class="line">            if (mTryAgainTimesMax &lt; 0 || mTryAgainCounter &lt;= mTryAgainTimesMax) &#123;</span><br><span class="line">                resetAlarm(mPollingIntervalShorterMs);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                // Try much later</span><br><span class="line">                mTryAgainCounter = 0;</span><br><span class="line">                resetAlarm(mPollingIntervalMs);</span><br><span class="line">            &#125;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    resetAlarm(mPollingIntervalMs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="æ‰§è¡Œé€»è¾‘"><a href="#æ‰§è¡Œé€»è¾‘" class="headerlink" title="æ‰§è¡Œé€»è¾‘"></a>æ‰§è¡Œé€»è¾‘</h4><p>å¦‚æœå·²ç»è®¾ç½®è¿‡äº†ï¼Œå¹¶ä¸”å’Œå‰ä¸€æ¬¡è®¾ç½®çš„æ—¶é—´å°äºè½®è¯¢æ—¶é—´ï¼Œ<br>    ä¸‹ä¸€ä¸ªè½®è¯¢æ—¶é—´åå†æ¥çœ‹ï¼Œ<br>å¦‚æœä¸Šæ¬¡åˆ·æ–°æ—¶é—´å’Œè°ƒç”¨æ­¤æ–¹æ³•çš„æ—¶é—´å·®å¤§äºäº†è½®è¯¢æ—¶é—´ï¼Œ<br>    è¯´æ˜ä¸Šæ¬¡è½®è¯¢è¶…æ—¶ï¼Œå¼ºåˆ¶æ›´æ–°ã€‚<br>æ²¡æœ‰è®¾ç½®æ—¶é—´||å½“å‰å¯åŠ¨æ—¶é—´å¤§äºä¸Šæ¬¡è½®è¯¢æ—¶é—´+è½®è¯¢é—´éš”ï¼Œæˆ–è€…ç”¨æˆ·æ”¹å˜äº†è‡ªåŠ¨æ ¡æ—¶<br>    ä¸Šæ¬¡tcpè¯·æ±‚åˆ°è°ƒç”¨getCacheAge()ä¹‹é—´çš„æ—¶é—´é—´éš”&gt;è½®è¯¢çš„æ—¶é—´é—´éš”<br>        ç›´æ¥å¼ºåˆ¶æ›´æ–°<br>    å°äºçš„æ˜¯æ—¶å€™<br>        ntp è·å¾—æ—¶é—´å’Œå½“å‰æ—¶é—´å¤§äºå®¹é”™æ—¶é—´çš„æ—¶å€™||æˆ–è€…æ—¶é—´æ²¡è®¾ç½®çš„æ—¶å€™<br>        è®¾ç½®æ—¶é—´<br>        åŒæ—¶é¡µè·³å‡ºäº†ä¸€åªå®šæ—¶è½®è¯¢çš„å¾ªç¯<br>    å‰©ä¸‹çš„æ˜¯æ¯æ¬¡éƒ½ä¼šæ‰§è¡Œ<br>        é‡è¯•æ¬¡æ•°++;<br>        æ£€éªŒæ—¶é—´è®¡æ•°<br>        æœ‰æ²¡æœ‰è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°çš„æ—¶å€™<br>            è½®è¯¢æ—¶é—´è®¾ç½®çŸ­ç‚¹<br>        è¶…è¿‡äº†<br>            é‡ç½®é‡è¯•æ¬¡æ•°<br>        å¹¶ä¸”è¯·ä¸‹æ¬¡è½®è¯¢æ—¶é—´å¢å¤§<br>éƒ½æœ‰æ²¡æ»¡è¶³ï¼Œä¸‹æ¬¡å†è¯´</p>
<h3 id="ç³»ç»Ÿæ ¡æ—¶æ€»ç»“"><a href="#ç³»ç»Ÿæ ¡æ—¶æ€»ç»“" class="headerlink" title="ç³»ç»Ÿæ ¡æ—¶æ€»ç»“"></a>ç³»ç»Ÿæ ¡æ—¶æ€»ç»“</h3><p>å†™æ³•çš„å·§å¦™ä¹‹å¤„<br>åœ¨äºï¼Œä¸¤ä¸ªä¸åŒçš„è½®è¯¢é—´éš”mPollingIntervalShorterMså’ŒmPollingIntervalMs<br>ç¬¬ä¸€æ¬¡ï¼Œå¼ºåˆ¶æ›´æ–°åä½†å¹¶ä¸ä¼šè®¾ç½®æ—¶é—´ï¼Œè€Œæ˜¯ç­‰åˆ°mPollingIntervalShorterMsä¸‹æ¬¡æ‹¿è®¾ç½®æ—¶é—´ï¼Œ<br>è€Œä¸‹æ¬¡æ¥è®¾ç½®æ—¶é—´çš„æ—¶å€™ï¼Œä¸€èˆ¬ç½‘ç»œæƒ…å†µè¾ƒå¥½çš„æ—¶å€™ï¼Œæ˜¯èƒ½æŠŠæ—¶é—´è·å–å¾—åˆ°<br>å°†æ—¶é—´ä¿å­˜åœ¨mTimeä¸­çš„mCachedNtpTimeä¸­ï¼ŒåŒæ—¶è®°å½•äº†è·å–æ—¶é—´æ—¶çš„å¼€æœºæ—¶é—´</p>
<p>ä¸‹æ¬¡è°ƒç”¨çš„æ—¶å€™ï¼ŒmTime.getCacheAge()åŸºæœ¬éƒ½ä¼šå°äºmPollingIntervalMs<br>è¿™æ˜¯æ—¶å€™å°±å¯ä»¥å¾—åˆ°ntpæ—¶é—´äº†(mTime.currentTimeMillis();)è¿™ä¸ªæ—¶é—´æ˜¯ç”±ä¸Šæ¬¡ntpè·å–çš„æ—¶é—´+å½“å‰å¼€æœºæ—¶é—´-ä¸Šæ¬¡è·å–ntpæ—¶é—´æ—¶çš„å¼€æœºæ—¶é—´<br>å†åˆ¤æ–­æ–­ä¸€ä¸‹æ˜¯å¦éœ€è¦è®¾ç½®æ—¶é—´ã€‚<br>è¿™æ˜¯åå°±è·³å‡ºè½®è¯¢äº†ã€‚</p>
<p>æ²¡æœ‰æ»¡è¶³æ¡ä»¶å°±ä¼šresetAlarm(),åœ¨mPollingIntervalMsååœ¨registerForAlarmsæ³¨å†Œçš„å¹¿æ’­ï¼Œ<br>å‘é€æ¶ˆæ¯åˆ°MyHandler, æœ€åè¿˜æ˜¯åˆ°onPollNetworkTimeUnderWakeLock<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">private void registerForAlarms() &#123;</span><br><span class="line">    mContext.registerReceiver(</span><br><span class="line">        new BroadcastReceiver() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void onReceive(Context context, Intent intent) &#123;</span><br><span class="line">                mHandler.obtainMessage(EVENT_POLL_NETWORK_TIME).sendToTarget();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, new IntentFilter(ACTION_POLL));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">* Cancel old alarm and starts a new one for the specified interval.</span><br><span class="line">*</span><br><span class="line">* @param interval when to trigger the alarm, starting from now.</span><br><span class="line">*/</span><br><span class="line">private void resetAlarm(long interval) &#123;</span><br><span class="line">    mAlarmManager.cancel(mPendingPollIntent);</span><br><span class="line">    long now = SystemClock.elapsedRealtime();</span><br><span class="line">    long next = now + interval;</span><br><span class="line">    mAlarmManager.set(AlarmManager.ELAPSED_REALTIME, next, mPendingPollIntent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="å¯¹äºæˆ‘ä»¬appæ¥è¯´åº”è¯¥æ€ä¹ˆå¼„"><a href="#å¯¹äºæˆ‘ä»¬appæ¥è¯´åº”è¯¥æ€ä¹ˆå¼„" class="headerlink" title="å¯¹äºæˆ‘ä»¬appæ¥è¯´åº”è¯¥æ€ä¹ˆå¼„"></a>å¯¹äºæˆ‘ä»¬appæ¥è¯´åº”è¯¥æ€ä¹ˆå¼„</h2><h3 id="è®¾ç½®æ—¶é—´ç›®å‰æˆ‘ä»¬æœ‰4ç§æ–¹å¼"><a href="#è®¾ç½®æ—¶é—´ç›®å‰æˆ‘ä»¬æœ‰4ç§æ–¹å¼" class="headerlink" title="è®¾ç½®æ—¶é—´ç›®å‰æˆ‘ä»¬æœ‰4ç§æ–¹å¼"></a>è®¾ç½®æ—¶é—´ç›®å‰æˆ‘ä»¬æœ‰4ç§æ–¹å¼</h3><p>SystemClock.setCurrentTimeMillis(ntp);<br>((AlarmManager) context.getSystemService(Context.ALARM_SERVICE)).setTime(when);<br>ç”¨shellå‘½ä»¤æ¥å¼„<br>è½®è¯¢çš„æ–¹å¼è®¾ç½®ä¸ºè‡ªåŠ¨æ ¡æ—¶ï¼ˆè¿™æ˜¯æ–¹å¼è¿˜æ²¡è¯•è¿‡ï¼Œå®Œå…¨ä¾èµ–ç³»ç»Ÿè¿˜æ˜¯æ¯”è¾ƒé è°±çš„ï¼‰<br>Settings.Global.putInt(getContentResolver(), Settings.Global.AUTO_TIME_ZONE, 1);<br>éœ€è¦åœ¨mainfest.xmlæ·»åŠ å†™å…¥ç³»ç»Ÿè®¾ç½®çš„æƒé™ï¼ˆè¿™ä¸ªå¾ˆæ²¡èŠ‚æ“ï¼‰<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--å†™ç³»ç»Ÿè®¾ç½®æ ¡æ—¶ç”¨çš„è®¾ç½®ä¸ºè‡ªåŠ¨æ ¡æ—¶--&gt;</span><br><span class="line">&lt;uses-permission android:name=&quot;android.permission.WRITE_SECURE_SETTINGS&quot;/&gt;</span><br><span class="line">&lt;uses-permission android:name=&quot;android.permission.READ_SECURE_SETTINGS&quot;/&gt;</span><br></pre></td></tr></table></figure></p>
<p>1, 2 ä¸¤ç§éœ€è¦ç³»ç»Ÿç­¾åï¼Œè€Œ3.ä¸‰ç§éœ€è¦æœ‰rootæƒé™ã€‚å¦‚æœè¿™ä¸¤ç§éƒ½æ²¡æœ‰ï¼ŒæŠ±æ­‰è‡£å¦¾åšä¸åˆ°<br>è¿˜æœ‰ä¸€ç§æ˜¯è½®è¯¢è®¾ç½®è‡ªåŠ¨æ ¡æ—¶ï¼Œè¿™ç§ä¸é“å¾·ï¼Œä½†æ˜¯ä¹Ÿæ˜¯è¢«é€¼çš„ğŸ˜†</p>
<p>æˆ‘ä»¬çš„appæ²¡æœ‰ç³»ç»Ÿç­¾åï¼Œæœ‰rootæƒé™ï¼Œæ¯”è¾ƒå¥‡è‘©</p>
<p>ç¬¬4ç§æ˜¯éœ€è¦ç³»ç»Ÿçº§appçš„æƒé™ã€‚</p>
<p>æ ¡æ—¶çš„å®ç°<br>å½“ç„¶æˆ‘ä»¬è¿™ç§ç½‘ç»œæ ¡æ—¶æœ‰ä¸­ä¸å¥½çš„æƒ…å†µï¼Œ<br>å°±æ˜¯æˆ‘ä»¬çš„æ ¡æ—¶å…ˆäºç³»ç»Ÿçš„æ ¡æ—¶ï¼Œè¿™æ—¶å€™ä¼šè§¦å‘ä¸¤æ¬¡æ—¶é—´æ”¹å˜çš„å¹¿æ’­</p>
<p>æ—¶é—´æ”¹å˜åï¼Œé‡æ–°æäº¤ä¸€ä¸‹fragmentï¼ˆç®€å•ç²—æš´æˆ‘å–œæ¬¢ï¼‰</p>
<p>æ ¡æ—¶çš„services;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">public class SyncTimeService extends Service &#123;</span><br><span class="line">    private static final String TAG = SyncTimeService.class.getSimpleName();</span><br><span class="line">    private Timer mTimer;</span><br><span class="line">    public SyncTimeService() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public IBinder onBind(Intent intent) &#123;</span><br><span class="line">        // TODO: Return the communication channel to the service.</span><br><span class="line">        throw new UnsupportedOperationException(&quot;Not yet implemented&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public int onStartCommand(Intent intent, int flags, int startId) &#123;</span><br><span class="line"></span><br><span class="line">        return super.onStartCommand(intent, flags, startId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onCreate() &#123;</span><br><span class="line">        super.onCreate();</span><br><span class="line">        if (mTimer == null)&#123;</span><br><span class="line">            mTimer = new Timer();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            mTimer.cancel();</span><br><span class="line">            mTimer = null;</span><br><span class="line">            mTimer = new Timer();</span><br><span class="line">        &#125;</span><br><span class="line">        mTimer.schedule(new TimerTask() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    URLConnection uc = new URL(&quot;http://www.baidu.com&quot;).openConnection();</span><br><span class="line">                    uc.connect();</span><br><span class="line">                    calendar = Calendar.getInstance();</span><br><span class="line">                    int year = calendar.get(Calendar.YEAR);</span><br><span class="line">                    DebugLogger.d(TAG, &quot;æ²¡å¤„ç†çš„ç½‘ç»œæ—¶é—´ï¼š&quot;+new Date(uc.getDate()));</span><br><span class="line">                    calendar.setTimeInMillis(uc.getDate());</span><br><span class="line">                    // ç™¾åº¦æ˜¯GMT 0:00æ—¶åŒºï¼Œéœ€è¦è½¬åˆ°GMT +8:00æ—¶åŒº</span><br><span class="line">                    calendar.setTimeZone(new SimpleTimeZone(8, &quot;GMT&quot;));</span><br><span class="line">                    data = calendar.getTimeInMillis();</span><br><span class="line">                    DebugLogger.d(TAG, &quot;å¾—åˆ°çš„ç½‘ç»œæ—¶é—´ï¼š&quot;+new Date(calendar.getTimeInMillis()).toString());</span><br><span class="line">                    DebugLogger.d(TAG, &quot;å¾—åˆ°çš„ç³»ç»Ÿæ—¶é—´ï¼š&quot;+new Date(Calendar.getInstance().getTimeInMillis()));</span><br><span class="line">                    // å¹´ä»½ç›¸åŒç›´æ¥åœæ­¢</span><br><span class="line">                    if (year == calendar.get(Calendar.YEAR))&#123;</span><br><span class="line">                        DebugLogger.d(TAG,&quot;ç³»ç»Ÿçš„ç½‘ç»œæ ¡æ—¶æˆåŠŸæˆ–è€…å·²ç»æ ¡å¯¹è¿‡æ—¶é—´äº†&quot;);</span><br><span class="line">                        stopSelf();</span><br><span class="line">                        return;</span><br><span class="line">                    &#125;</span><br><span class="line">                    SimpleDateFormat simpleDateFormat = new SimpleDateFormat(&quot;yyyyMMdd.HHmmss&quot;);</span><br><span class="line">                    Date date = new Date(data);</span><br><span class="line">                    String format = simpleDateFormat.format(date);</span><br><span class="line">                    String shellString = &quot;date -s &quot; +format;</span><br><span class="line">                    // è®¾ç½®æ—¶åŒºï¼Œåªèƒ½æ˜¯è¿™ä¸ªé—®é¢˜äº†ï¼Œè¿™ä¸ªå¾ˆå¿«å°±é—ªè¿‡å»äº†ï¼Œæš‚æ—¶æ²¡æ‰¾åˆ°åˆé€‚çš„åŸå› </span><br><span class="line">                    shellString += &quot;&amp;&amp; setprop persist.sys.timezone \&quot;Asia/Shanghai\&quot;&quot;;</span><br><span class="line">                    RootCmd.execRootCmd(shellString);</span><br><span class="line">                    DebugLogger.d(TAG,&quot;ç½‘ç»œæ ¡æ—¶æˆåŠŸ&quot;);</span><br><span class="line">                    DebugLogger.d(TAG, &quot;æ‰§è¡Œçš„shellå‘½ä»¤ï¼š&quot;+shellString);</span><br><span class="line">                    DebugLogger.d(TAG,&quot;æ ¡æ—¶è¿‡åçš„æ—¶åŒºï¼š&quot;+ TimeZone.getDefault().getDisplayName());</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                    DebugLogger.d(&quot;SyncTimeService&quot;,&quot;ç½‘ç»œæ ¡æ—¶å¤±è´¥&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, 0,5000);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onDestroy() &#123;</span><br><span class="line">        super.onDestroy();</span><br><span class="line">        if (mTimer != null)&#123;</span><br><span class="line">            mTimer.cancel();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ä¸€èˆ¬éƒ½æ˜¯ç³»ç»Ÿæ ¡æ—¶å¿«äºæˆ‘ä»¬æ‰‹åŠ¨æ‰§è¡Œæ ¡æ—¶ã€‚<br>å‚è€ƒ</p>
<p><a href="https://blog.csdn.net/firedancer0089/article/details/59526369" target="_blank" rel="noopener">https://blog.csdn.net/firedancer0089/article/details/59526369</a></p>
</div><div class="tags"><a href="/tags/Android/">Android</a></div><div class="post-nav"><a class="next" href="/2018/08/03/IoT_deploy/">IoTéƒ¨ç½²ç›¸å…³</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://yoursite.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> åˆ†ç±»</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Androidç³»ç»Ÿ/">Androidç³»ç»Ÿ</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Gradle/">Gradle</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/å‰ç«¯/">å‰ç«¯</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/å·¥å…·/">å·¥å…·</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> æ ‡ç­¾</i></div><div class="tagcloud"><a href="/tags/åµŒå…¥å¼/" style="font-size: 15px;">åµŒå…¥å¼</a> <a href="/tags/æœˆè®°/" style="font-size: 15px;">æœˆè®°</a> <a href="/tags/Context/" style="font-size: 15px;">Context</a> <a href="/tags/AndroidåŸç†/" style="font-size: 15px;">AndroidåŸç†</a> <a href="/tags/ç¡¬ä»¶/" style="font-size: 15px;">ç¡¬ä»¶</a> <a href="/tags/Ionic/" style="font-size: 15px;">Ionic</a> <a href="/tags/Gradle/" style="font-size: 15px;">Gradle</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/VLC/" style="font-size: 15px;">VLC</a> <a href="/tags/Git/" style="font-size: 15px;">Git</a> <a href="/tags/æŠ˜è…¾/" style="font-size: 15px;">æŠ˜è…¾</a> <a href="/tags/flex/" style="font-size: 15px;">flex</a> <a href="/tags/æ„Ÿæ‚Ÿ/" style="font-size: 15px;">æ„Ÿæ‚Ÿ</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/åšå®¢/" style="font-size: 15px;">åšå®¢</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> æœ€è¿‘æ–‡ç« </i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/08/04/Androidæ ¡æ—¶å…¨è¿‡ç¨‹/">Android æ ¡æ—¶å…¨è¿‡ç¨‹</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/03/IoT_deploy/">IoTéƒ¨ç½²ç›¸å…³</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/16/å¹´æœ«äº†/">å¹´æœ«äº†</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/13/äº‹ä»¶åˆ†å‘æœºåˆ¶/">äº‹ä»¶åˆ†å‘æœºåˆ¶</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/10/Androidæ¶ˆæ¯æœºåˆ¶/">Androidæ¶ˆæ¯æœºåˆ¶</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/29/æ¯”åˆ†æ›´æ–°åŠŸèƒ½è®°å½•/">æ¯”åˆ†æ›´æ–°åŠŸèƒ½è®°å½•</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/10/Handlerä½¿ç”¨çš„ä½¿ç”¨/">Handlerä½¿ç”¨ï¼Œå†…å­˜æ³„æ¼çš„å‰å‰åå</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/08/å¸¸ç”¨çš„gitå‘½ä»¤/">å¸¸ç”¨çš„gitå‘½ä»¤</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/06/Androidè¿›ç¨‹çº¿ç¨‹å’Œå†…å­˜/">Androidè¿›ç¨‹/çº¿ç¨‹å’Œå†…å­˜</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/06/å¼•å­/">å¼•å­</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright Â© 2018 <a href="/." rel="nofollow">JsonMi.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>